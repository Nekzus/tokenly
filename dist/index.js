import e from"crypto";import t from"jsonwebtoken";class r{constructor(t){this.currentToken=null,this.blacklistedTokens=new Set,this.deviceTokens=new Map,this.rotationCounts=new Map,this.revokedTokens=new Set,this.autoRotationInterval=null,this.fingerprintCache=new Map,this.secretAccess=process.env.JWT_SECRET_ACCESS||"default-secret-access",this.secretRefresh=process.env.JWT_SECRET_REFRESH||"default-secret-refresh",this.accessTokenExpiry=t?.accessTokenExpiry||process.env.ACCESS_TOKEN_EXPIRY||"15m",this.refreshTokenExpiry=t?.refreshTokenExpiry||process.env.REFRESH_TOKEN_EXPIRY||"7d",this.cookieOptions={httpOnly:!0,secure:"production"===process.env.NODE_ENV,sameSite:"strict",path:"/",maxAge:6048e5,...t?.cookieOptions},this.jwtOptions={algorithm:"HS512",issuer:"tokenly-auth",audience:"tokenly-client",...t?.jwtOptions},this.verifyOptions={algorithms:[this.jwtOptions.algorithm],issuer:this.jwtOptions.issuer,audience:this.jwtOptions.audience,clockTolerance:30},this.rotationConfig={enableAutoRotation:!0,rotationInterval:60,maxRotationCount:100,...t?.rotationConfig},this.securityConfig={enableFingerprint:!0,enableBlacklist:!0,maxDevices:5,revokeOnSecurityBreach:!0,...t?.securityConfig},this.eventListeners=new Map,this.tokenCache=new Map,this.instanceSalt=e.randomBytes(32).toString("hex")}formatDate(e){return new Date(1e3*e).toISOString()}decodeWithReadableDates(e,r){r||(r=t.decode(e));const{iat:n,exp:o,...i}=r;return{raw:e,payload:{...i,iat:n?this.formatDate(n):void 0,exp:o?this.formatDate(o):void 0}}}generateFingerprint(t){if(!t?.userAgent?.trim()||!t?.ip?.trim())throw new Error("Invalid or empty context values");const r=t.userAgent.trim().toLowerCase().replace(/\s+/g," "),n=t.ip.trim().toLowerCase().replace(/[^0-9.]/g,""),o=`ua=${e.createHash("sha256").update(`ua:${this.instanceSalt}:${r}`).digest("hex")}|ip=${e.createHash("sha256").update(`ip:${this.instanceSalt}:${n}`).digest("hex")}`;return e.createHash("sha256").update(o).digest("hex")}revokeToken(e){if(e)try{const r=t.decode(e);this.revokedTokens.add(e),this.emit("tokenRevoked",{token:e,userId:r?.userId,timestamp:Date.now()})}catch(e){console.error("Error al revocar token:",e)}}isTokenBlacklisted(e){return this.securityConfig.enableBlacklist&&this.blacklistedTokens.has(e)}validatePayload(e){if(null===e||"object"!=typeof e)throw new Error("Payload must be an object");if(0===Object.keys(e).length)throw new Error("Payload cannot be empty");if(!Object.prototype.hasOwnProperty.call(e,"userId"))throw new Error("Payload must contain a userId");if(null===e.userId||void 0===e.userId)throw new Error("userId cannot be null or undefined");if("string"!=typeof e.userId||!e.userId.trim())throw new Error("userId cannot be empty");Object.entries(e).forEach((([e,t])=>{if(null==t)throw new Error(`Payload property '${e}' cannot be null or undefined`)}));if(JSON.stringify(e).length>8192)throw new Error("Payload size exceeds maximum allowed size")}generateAccessToken(e,r,n){this.validatePayload(e);const o={...e};if(this.securityConfig.enableFingerprint&&n){const t=this.generateFingerprint(n),r=e.userId;this.handleDeviceStorage(r,t),o.fingerprint=t}const i=t.sign(o,this.secretAccess,{...this.jwtOptions,...r,expiresIn:this.accessTokenExpiry}),s=this.decodeWithReadableDates(i);return this.cacheToken(i,s),s}verifyAccessToken(e,r){if(this.revokedTokens.has(e)||this.isTokenBlacklisted(e))throw new Error("Token has been revoked");const n=t.verify(e,this.secretAccess,{...this.verifyOptions,ignoreExpiration:!1,clockTolerance:0});if(this.securityConfig.enableFingerprint&&r){const e=this.generateFingerprint(r);if(n.fingerprint&&n.fingerprint!==e)throw new Error("Invalid token fingerprint")}const o=this.decodeWithReadableDates(e,n);return this.cacheToken(e,o),o}generateRefreshToken(e,r){this.validatePayload(e);const n={...e};delete n.aud,delete n.iss,delete n.exp,delete n.iat;const o=t.sign(n,this.secretRefresh,{...this.jwtOptions,expiresIn:this.refreshTokenExpiry}),i=this.decodeWithReadableDates(o);return i.cookieConfig={name:"refresh_token",value:o,options:{...this.cookieOptions,...r}},i}verifyRefreshToken(e){const r=t.verify(e,this.secretRefresh,this.verifyOptions);return this.decodeWithReadableDates(e,r)}rotateTokens(e){if(!e||"string"!=typeof e)throw new Error("Invalid refresh token format");const t=this.verifyRefreshToken(e),{iat:r,exp:n,aud:o,iss:i,...s}=t.payload,a=e,c=this.rotationCounts.get(a)||0;if(c>=(this.rotationConfig.maxRotationCount||2))throw new Error("Maximum rotation count exceeded");return this.rotationCounts.set(a,c+1),{accessToken:this.generateAccessToken(s),refreshToken:this.generateRefreshToken(s)}}setToken(e){this.currentToken=e}getToken(){return this.currentToken}clearToken(){this.currentToken=null}isTokenExpiringSoon(e,r=5){try{const n=t.decode(e);if(!n||!n.exp)return!1;const o=1e3*n.exp,i=Date.now();return o-i<60*r*1e3}catch{return!1}}getTokenInfo(e){try{const r=t.decode(e);return r?{userId:r.userId,expiresAt:new Date(1e3*r.exp),issuedAt:new Date(1e3*r.iat),fingerprint:r.fingerprint}:null}catch{return null}}validateTokenFormat(e){try{const t=e.split(".");return 3===t.length&&t.every((e=>{try{return Buffer.from(e,"base64").toString(),!0}catch{return!1}}))}catch{return!1}}generateOneTimeToken(r,n="5m"){const o={purpose:r,nonce:e.randomBytes(16).toString("hex"),iat:Math.floor(Date.now()/1e3)};return t.sign(o,this.secretAccess,{expiresIn:n})}verifyRefreshTokenEnhanced(e){if(!this.validateTokenFormat(e))throw new Error("Invalid token format");const t=this.verifyRefreshToken(e);if(this.isTokenExpiringSoon(e,60))throw new Error("Refresh token is about to expire");return t}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e)?.push(t)}emit(e,t){const r=this.eventListeners.get(e);r?.length&&r.forEach((e=>{try{e(t)}catch(e){}}))}cacheToken(e,t){this.tokenCache.set(e,t),setTimeout((()=>{this.tokenCache.delete(e)}),3e5)}analyzeTokenSecurity(e){const r=t.decode(e,{complete:!0});if(!r)throw new Error("Invalid token");return{algorithm:r.header.alg,hasFingerprint:!!r.payload.fingerprint,expirationTime:new Date(1e3*r.payload.exp),issuedAt:new Date(1e3*r.payload.iat),timeUntilExpiry:1e3*r.payload.exp-Date.now(),strength:this.calculateTokenStrength(r)}}calculateTokenStrength(e){let t=0;"HS512"===e.header.alg?t+=2:"HS256"===e.header.alg&&(t+=1),e.payload.fingerprint&&(t+=2);const r=1e3*e.payload.exp-Date.now();return r<9e5?t+=1:r<36e5&&(t+=2),t<=2?"weak":t<=4?"medium":"strong"}enableAutoRotation(e={}){console.log("Enabling auto rotation...");const{checkInterval:t=50,rotateBeforeExpiry:r=1e3}=e;return this.autoRotationInterval&&clearInterval(this.autoRotationInterval),this.checkTokensExpiration(r),this.autoRotationInterval=setInterval((()=>{this.checkTokensExpiration(r)}),t),this.autoRotationInterval}disableAutoRotation(){this.autoRotationInterval&&(clearInterval(this.autoRotationInterval),this.autoRotationInterval=null)}checkTokensExpiration(e){Array.from(this.tokenCache.entries()).forEach((([r,n])=>{try{const n=t.decode(r);if(n?.exp){const t=1e3*n.exp-Date.now();t<e&&this.emit("tokenExpiring",{token:r,userId:n.userId,expiresIn:t})}}catch(e){}}))}enableAutoCleanup(e=36e5){setInterval((()=>{const e=Date.now();this.revokedTokens.forEach((r=>{try{const n=t.decode(r);n&&n.exp&&1e3*n.exp<e&&this.revokedTokens.delete(r)}catch{this.revokedTokens.delete(r)}}))}),e)}handleDeviceStorage(e,t){this.deviceTokens.has(e)||this.deviceTokens.set(e,new Set);const r=this.deviceTokens.get(e),n=`${e}:${t}`;if(!this.fingerprintCache.has(n)){if(r.size>=this.securityConfig.maxDevices)throw new Error("Maximum number of devices reached");this.fingerprintCache.set(n,t)}r.add(t)}}function n(e,t){const r=e["x-real-ip"];if("string"==typeof r&&r.trim())return r.trim();const n=e["x-forwarded-for"];return"string"==typeof n&&n.trim()?n.split(",")[0].trim():t||""}export{r as Tokenly,n as getClientIP};
//# sourceMappingURL=index.js.map
